name: Daily Q&A Backup

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Manual trigger
  push:
    paths:
      - '_OUTPUT/*.json'
      - '_EXTRACTED_FRAGEN/*.json'

permissions:
  contents: write  # WICHTIG: erlaubt Pushes mit GITHUB_TOKEN

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history for proper backup
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Create backup directory
        run: |
          DATE=$(date +%Y%m%d_%H%M%S)
          mkdir -p backups/$DATE
          echo "BACKUP_DIR=backups/$DATE" >> $GITHUB_ENV
          echo "BACKUP_DATE=$DATE" >> $GITHUB_ENV
      
      - name: Backup Output files
        run: |
          if [ -d "_OUTPUT" ]; then
            cp _OUTPUT/*.json "$BACKUP_DIR/" 2>/dev/null || echo "No JSON files in _OUTPUT/"
          fi
          
          if [ -d "_EXTRACTED_FRAGEN" ]; then
            cp _EXTRACTED_FRAGEN/*.json "$BACKUP_DIR/" 2>/dev/null || echo "No JSON files in _EXTRACTED_FRAGEN/"
          fi
          
          # Create backup manifest
          cat > "$BACKUP_DIR/MANIFEST.md" << EOF
          # Backup Manifest
          
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Trigger:** ${{ github.event_name }}
          **Commit:** ${{ github.sha }}
          
          ## Files Backed Up
          
          \`\`\`
          $(ls -lh $BACKUP_DIR/*.json 2>/dev/null || echo "No JSON files")
          \`\`\`
          EOF
      
      - name: Validate Q&A count
        id: validate
        run: |
          # Check if we have any JSON files
          if ls _OUTPUT/*.json 1> /dev/null 2>&1; then
            # Try to count Q&A pairs (adapt to your JSON structure)
            COUNT=$(python3 -c "
            import json
            import sys
            try:
                with open('_OUTPUT/qa_gold_standard.json', 'r') as f:
                    data = json.load(f)
                    # Adapt this to your actual structure
                    count = len(data.get('questions', data if isinstance(data, list) else []))
                    print(count)
            except FileNotFoundError:
                print(0)
            except Exception as e:
                print(f'Error: {e}', file=sys.stderr)
                print(0)
            " 2>/dev/null || echo "0")
            
            echo "QA_COUNT=$COUNT" >> $GITHUB_ENV
            echo "count=$COUNT" >> $GITHUB_OUTPUT
            
            if [ "$COUNT" -lt 100 ]; then
              echo "⚠️ WARNING: Q&A count is low ($COUNT)"
            else
              echo "✅ Q&A count: $COUNT"
            fi
          else
            echo "QA_COUNT=0" >> $GITHUB_ENV
            echo "count=0" >> $GITHUB_OUTPUT
            echo "⚠️ No output files found yet"
          fi
      
      - name: Commit backup
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add backups/
          
          if git diff --staged --quiet; then
            echo "✅ No changes to commit"
          else
            git commit -m "chore: Daily backup $BACKUP_DATE - $QA_COUNT Q&A pairs"
            git push origin HEAD:${{ github.ref }}
            echo "✅ Backup committed and pushed"
          fi
      
      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: backup-${{ env.BACKUP_DATE }}
          path: ${{ env.BACKUP_DIR }}
          retention-days: 90
      
      - name: Notify on low count
        if: steps.validate.outputs.count < 100 && steps.validate.outputs.count > 0
        run: |
          echo "::warning::Q&A count is below threshold: ${{ steps.validate.outputs.count }}"
