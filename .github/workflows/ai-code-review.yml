name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ============================================
  # Claude AI Review (Anthropic)
  # ============================================
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > changed_files.txt
          echo "files=$(cat changed_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Claude Review
        if: secrets.ANTHROPIC_API_KEY != ''
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get diff content
          DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- '*.py' '*.js' '*.ts' | head -c 10000)

          if [ -z "$DIFF" ]; then
            echo "No code changes to review"
            exit 0
          fi

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 1024,
              \"messages\": [{
                \"role\": \"user\",
                \"content\": \"Review this code diff for a medical exam AI project. Focus on: 1) Medical accuracy risks 2) Security issues 3) Code quality. Be concise.\n\nDiff:\n$DIFF\"
              }]
            }" | jq -r '.content[0].text // "Review failed"')

          # Post comment
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## Claude Code Review

          $RESPONSE

          ---
          *Reviewed by Claude (Anthropic)*"

  # ============================================
  # Gemini AI Review (Google)
  # ============================================
  gemini-review:
    name: Gemini Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gemini Review
        if: secrets.GOOGLE_AI_API_KEY != ''
        env:
          GOOGLE_AI_API_KEY: ${{ secrets.GOOGLE_AI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DIFF=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} -- '*.py' | head -c 8000)

          if [ -z "$DIFF" ]; then
            echo "No Python changes to review"
            exit 0
          fi

          # Call Gemini API
          RESPONSE=$(curl -s "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=$GOOGLE_AI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"parts\": [{
                  \"text\": \"Review this Python code diff for medical AI. Check for bugs, security issues, and suggest improvements. Be concise.\n\n$DIFF\"
                }]
              }]
            }" | jq -r '.candidates[0].content.parts[0].text // "Review failed"')

          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## Gemini Code Review

          $RESPONSE

          ---
          *Reviewed by Gemini (Google AI)*"

  # ============================================
  # GitHub Copilot (native integration)
  # ============================================
  # Note: GitHub Copilot PR reviews are enabled via repository settings
  # Go to: Settings > Copilot > Enable "Copilot for pull requests"

  # ============================================
  # CodeRabbit AI (recommended for OSS)
  # ============================================
  # Add CodeRabbit by installing the GitHub App:
  # https://github.com/apps/coderabbit

  # ============================================
  # AI-Triggered Actions on Issue Comments
  # ============================================
  ai-assist-comment:
    name: AI Assist on Comment
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      (contains(github.event.comment.body, '@claude') ||
       contains(github.event.comment.body, '@gemini') ||
       contains(github.event.comment.body, '@ai-review'))

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: AI Response
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          QUESTION="${{ github.event.comment.body }}"

          if [[ "$QUESTION" == *"@claude"* ]] && [ -n "$ANTHROPIC_API_KEY" ]; then
            RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
              -H "Content-Type: application/json" \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -d "{
                \"model\": \"claude-sonnet-4-20250514\",
                \"max_tokens\": 1024,
                \"messages\": [{
                  \"role\": \"user\",
                  \"content\": \"$QUESTION\"
                }]
              }" | jq -r '.content[0].text // "Could not generate response"')

            gh issue comment ${{ github.event.issue.number }} \
              --body "**Claude responds:**

          $RESPONSE"
          fi
